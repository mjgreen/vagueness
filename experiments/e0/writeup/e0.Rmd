---
title: "Experiment 0 pilot"
author: "Matt Green"
output:
  html_document:
    toc: yes
    toc_float: true
    mathjax: default
    template: default
    code_folding: show
    theme: default
  
---  

This document aims to be a complete and up to date record of the analysis for vagueness 0, the pilot experiment.

The pilot experiment used subitizable numbers as well as bigger numbers.
The instructions had the form: _Choose the square with {{few, many},{two, three, four, five, six, seven, eight, nine}} dots._
The variables were: subitizability; vagueness; target_size; gap_size; side (i.e., which side was the bigger number on?)

# Libraries and functions

```{r load knitr}
library(knitr)
```

Load libraries.

```{r load libraries, message=FALSE, warning=FALSE}
library(tidyverse)
library(broom)
library(dotwhisker)
library(grid)
library(gridExtra)
library(lme4)
# R CMD INSTALL broom.mixed # https://github.com/bbolker/broom.mixed
```

Source additional R files with functions for computing confidence intervals.

```{r sourceCIFunctions}
source("CIfunctions.R") # for summarySEwithin etc
```

# Data

Get the data. 

```{r "make the data.txt file unless it's already there; read the data from file, add some vars and code the added vars"}

# make the data file from the individual subjects' data unless it's already there in the directory
if (!file.exists("data.txt")) {
  system("echo 'gap\ttarget\tside\tvagueness\tpair\tVersion\tLeft\tRight\tText\tCondition\tcorrectAnswer\tsubject\tactualAnswer\tisCorrect\trt' > data.txt")
  system("cat ../experimentCode/output/*.dat >> data.txt", wait=TRUE)
}

# read in the data from file
din <- read_delim("data.txt", delim="\t")

# make an R object copy of that original data file
original_data <- din

# add observation number for the whole data set
din$obs <- 1:nrow(din)

# add trial index for each subject
din$trial <- 0
for (s in unique(din$subject)){
  din[din$subject==s, "trial"] <- 1:nrow(subset(din,subject==s))
}
```

```{r"make a tibble with factors explicit"}
# make a df to carry forward
d <- tibble(
  obs = din$obs, 
  trial = din$trial, 
  subject = as.factor(din$subject), 
  item = factor(din$pair, label = c("2:4", "3:5", "6:8", "7:9", "2:6", "7:3", "8:4", "5:9")),
  gap = factor(din$gap, levels = c("BigGap", "SmallGap"), labels = c("Big Gap", "Small Gap")), 
  quan = factor(din$target, levels = c("BigTarget", "SmallTarget"), labels = c("Big Target", "Small Target")), 
  vag = factor(din$vagueness, levels = c("Precise", "Vague"), labels = c("Crisp", "Vague")), 
  subit = factor(ifelse(din$pair %in% c(1,2,5,6), "Subitizable", "Not subitizable")),
  side = factor(din$side), 
  text = factor(din$Text),
  err = 1 - din$isCorrect, 
  rt_raw = ifelse(din$rt >=0, din$rt, NA),
  rt_ms = ifelse(1-din$isCorrect==1, NA, ifelse(din$rt >=0, din$rt, NA)), # restricting rt to positive values (rt>=0) converted a score of -6 ms to NA
  rt_log = log( ifelse(1-din$isCorrect==1, NA, ifelse(din$rt >=0, din$rt, NA)) ),
  "rt_reciprocal[-1/rt]" = -1/ifelse(1-din$isCorrect==1, NA, ifelse(din$rt >=0, din$rt, NA)), # We multiplied reciprocal scores [1/RT] by -1 [-1/RT] to maintain the direction of effects compatible for the three variants, effectively converting speed [number of responses per ms] into 'rate of slowing' - A linear mixed model analysis of masked repetition priming, Kliegl, Masson & Richter, VISUAL COGNITION,2010,18(5),655--681 (p.~662)
  rt_reciprocal = -1000/ifelse(1-din$isCorrect==1, NA, ifelse(din$rt >=0, din$rt, NA))
)
d$c.vag = ifelse(d$vag=="Crisp", -.5, .5)
```

Size of the data is `r nrow(d)` trials. 1 was removed for being impossible ($-6~ms$). There are `r nrow(subset(d,err==1))` error trials. The variable rt_ms has NA in the case that an error was made. The variable rt_raw includes rt for error trials.

## Eyeball the RTs

### Uncapped, max of 20,000 ms

```{r fig.show='hide', warning=FALSE, echo=FALSE}
# all the (correct) RTs
summary(d$rt_ms)

data_for_plot <- gather(d, key=rt_metric, value=rt_value, rt_ms, rt_log, "rt_reciprocal[-1/rt]") %>%
  arrange(rt_value)

ga1untrimmed = ggplot(data_for_plot, aes(x=rep(1:1600,times=3), y=rt_value)) + 
  geom_point(na.rm=TRUE) + 
  facet_wrap(~factor(rt_metric, levels=c("rt_ms", "rt_log", "rt_reciprocal[-1/rt]")), scales="free_y") +
  xlab("observations, ordered by rt_value") + theme(aspect.ratio = 1, axis.text.x = element_text(angle = 45, hjust = 1))

ga2untrimmed = ggplot(data_for_plot, aes(rt_value)) +
  geom_density(na.rm=TRUE) +
  facet_wrap(~factor(rt_metric, levels=c("rt_ms", "rt_log", "rt_reciprocal[-1/rt]")), scales="free") + theme(aspect.ratio = 1, axis.text.x = element_text(angle = 45, hjust = 1))

myg1 <- grid.arrange(ga1untrimmed, ga2untrimmed, nrow=2, top = textGrob("Untrimmed",gp=gpar(fontsize=20,font=3)))
```

### Capped at 10,000 ms

```{r fig.show='hide', warning=FALSE, echo=FALSE}
# now with a simple cap imposed at 10000 ms, half-way through the maximum allotted time of 20000 (2 minute timeout)
summary(d$rt_ms[d$rt_ms<10000])

data_for_plot <- gather(d %>% filter(rt_ms<10000), key=rt_metric, value=rt_value, rt_ms, rt_log, "rt_reciprocal[-1/rt]") %>%
  arrange(rt_value)

ga1trimmed = ggplot(data_for_plot, aes(x=rep(1:1556,times=3), y=rt_value)) + 
  geom_point(na.rm=TRUE) + 
  facet_wrap(~factor(rt_metric, levels=c("rt_ms", "rt_log", "rt_reciprocal[-1/rt]")), scales="free_y") +
  xlab("observations, ordered by rt_value")+ theme(aspect.ratio = 1, axis.text.x = element_text(angle = 45, hjust = 1))

ga2trimmed = ggplot(data_for_plot, aes(rt_value)) +
  geom_density(na.rm=TRUE) +
  facet_wrap(~factor(rt_metric, levels=c("rt_ms", "rt_log", "rt_reciprocal[-1/rt]")), scales="free") + theme(aspect.ratio = 1, axis.text.x = element_text(angle = 45, hjust = 1))

myg2 <- grid.arrange(ga1trimmed, ga2trimmed, nrow=2, top = textGrob("Trimmed at 10,1000 ms",gp=gpar(fontsize=20,font=3)))
``` 

```{r, fig.width=10,fig.height=10}
grid.arrange(myg1, myg2, nrow=2)
```


Select either trimmed or untrimmed data by comparing this plot with the untrimmed data. Also use this plot to choose the most normal data (logRT).

```{r selectTrim}
dat <- d %>% filter(rt_ms<10000)
```

# RT modelling

Do a first lmer model. You can't put subit or gap over items because they are between-items.

```{r, lmers}
lmer2 <- lmer(data=dat, rt_reciprocal~subit*vag + (vag|subject) + (vag|item))
# lmer3 is closer to the original anova than lmer2
lmer3 <- tidy(lme4::lmer(data=dat, rt_reciprocal~vag*subit+quan+gap + (vag+subit|subject) + (vag|item)))
dwplot(lmer3 %>% filter(group=="fixed"), vline = geom_vline(xintercept = 0, colour = "grey50", linetype = 2)) + xlab("Coefficient")
```


<!-- ```{r} -->
<!-- lmer3b <- lme4::lmer(data=dat, logRT~subit*vag+quan+gap + (subit*vag|subject) + (vag|item))  -->
<!-- lmer3b_tidy <- tidy(lmer3b) -->
<!-- lmer3b_tidy$model="foo" -->
<!-- lmer3b_tidy %>% filter(group=="fixed") %>% dwplot() -->
<!-- ``` -->

<!-- ```{r, summaryLMER, results='asis'} -->
<!-- print(xtable(summary(lmer3)$coefficients, digits=3), type="html") -->
<!-- ``` -->

<!-- ## subitizable -->

<!-- ```{r, subitRT, results='asis'} -->
<!-- print(xtable(summary(lmer(data=dat, subset=subit=="Subitizable",logRT~vag+quan+gap +(vag|subject)+(vag|item)))$coefficients, digits=3), type='html') -->
<!-- ``` -->

<!-- ## not subitizable -->

<!-- ```{r, notsubitrT, results='asis'} -->
<!-- print(xtable(summary(lmer(data=dat, subset=subit=="Not subitizable", logRT~vag+quan+gap +(vag|subject)+(vag|item)))$coefficients, digits=3), type='html') -->
<!-- ``` -->

<!-- # Error rate analysis -->

<!-- ```{r errorrates, results='asis'} -->
<!-- print(xtable(summary( -->
<!-- 	glmer(data=d, err~vag*subit+quan+gap + (vag|subject) + (1|item),  -->
<!-- 				family=binomial,  -->
<!-- 				control = glmerControl(optimizer = "bobyqa") -->
<!-- 				) -->
<!-- 	)$coefficients, -->
<!-- 	digits=3),  -->
<!-- 	type='html') -->
<!-- ``` -->

<!-- # Plots of significant effects -->

<!-- ```{r plot_sig, fig.width=7.5, fig.height=3} -->
<!-- a <- summarySEwithin(data=dat, measurevar="logRT", withinvars=c("vag","subit","item"), idvar="subject") -->
<!-- as <- subset(a,subit=="Subitizable") -->
<!-- as$item <- as.character(as$item) -->
<!-- as$item[as$item=="7:3"] <- "3:7" -->
<!-- as$item <- factor(as$item) -->
<!-- pd <- position_dodge(.05) -->
<!-- plot1 = ggplot(data=as, aes(y=logRT, x=item, ymin=logRT-ci, ymax=ci+logRT, fill=vag, group=vag)) +  -->
<!--   geom_line(position=pd) + -->
<!--   geom_errorbar(width=.2, position=pd)+ -->
<!--   geom_point(pch=21, size=4, position=pd) + -->
<!--   scale_fill_grey(name=element_blank(),start=0,end=1)+ -->
<!--   theme_bw()+ -->
<!--   theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.key=element_blank()) + -->
<!--   ggtitle("Response time") -->

<!-- a <- summarySEwithin(data=d, measurevar="err", withinvars=c("vag","subit","item"), idvar="subject") -->
<!-- as <- subset(a,subit=="Subitizable") -->
<!-- as$item <- as.character(as$item) -->
<!-- as$item[as$item=="7:3"] <- "3:7" -->
<!-- as$item <- factor(as$item) -->
<!-- pd <- position_dodge(.05) -->
<!-- plot2 = ggplot(data=as, aes(y=err, x=item, ymin=err-ci, ymax=ci+err, group=vag, fill=vag))+ -->
<!--   geom_line(position=pd) + -->
<!--   geom_errorbar(width=.2, position=pd)+ -->
<!--   geom_point(pch=21, size=4, position=pd) + -->
<!--   scale_fill_grey(name=element_blank(),start=0,end=1)+ -->
<!--   theme_bw()+ -->
<!--   theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.key=element_blank()) + -->
<!--   ggtitle("Error rate") -->

<!-- grid.arrange(plot1, plot2, nrow=1, top="Subitizable only") -->
<!-- ``` -->

<!-- ```{r barcharts, fig.width=9, fig.height=3} -->
<!-- bwtheme <- standard.theme("pdf", color=FALSE) -->
<!-- b1=barchart(data=ddply(dat,.(vag,subit),summarise, logRT=mean(logRT)),  -->
<!-- 						logRT~subit,  -->
<!-- 						group=vag, auto.key=list(space='right', cex=.7), par.settings=bwtheme) -->
<!-- b2=barchart(data=ddply(d,.(vag,subit),summarise, Error_Rate=mean(err)),  -->
<!-- 						Error_Rate~subit,  -->
<!-- 						group=vag, auto.key=list(space='right', cex=.7), par.settings=bwtheme) -->
<!-- grid.arrange(b1,b2,ncol=2) -->
<!-- ``` -->

<!-- Subitizability x Vagueness x Quantity -->

<!-- ```{r plotMeansa, fig.width=7, fig.height=3} -->
<!-- a <- summarySEwithin(data=dat, measurevar="logRT", withinvars=c("vag","quan","subit"), idvar="subject") -->
<!-- pd <- position_dodge(.1) -->
<!-- 	ggplot( -->
<!-- 		a,  -->
<!-- 		aes(y=logRT, x=vag, group=quan, shape=quan, col=quan, ymin=logRT-ci, ymax=ci+logRT) -->
<!-- 	) +  -->
<!-- 	geom_point(size=4, position=pd) +  -->
<!-- 	geom_line(position=pd) +  -->
<!-- 	facet_grid(~subit) +  -->
<!-- 	geom_errorbar(width=.1, position=pd) +  -->
<!-- 	theme_bw() +  -->
<!-- 	theme(panel.grid.major=element_blank())  -->
<!-- ``` -->

<!-- ```{r qqplotLMER, fig.width=3, fig.height=3.5} -->
<!-- qqPlot(residuals(lmer2),cex=.5) -->
<!-- ``` -->
