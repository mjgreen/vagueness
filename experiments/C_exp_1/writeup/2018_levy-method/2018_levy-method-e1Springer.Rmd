---
title: "This is experiment one in the springer 1 to 3 numbering (originaly called e2)"
author: "Matt Green"
output:
  html_document:
    toc: yes
    toc_float: true
    mathjax: default
    template: default
    <!--code_folding: show-->
    theme: default
---

```{r 'set working directory', echo=FALSE}
root="/home/matt/wd/vagueness/experiments/e2/writeup/2018_levy-method"
if (getwd() != root) setwd(root)
```

```{r 'load Libraries and source my functions', message=FALSE, echo=FALSE}
library(knitr)
library(tidyverse)
library(tidymodels)
library(broom.mixed)
library(lme4)
library(lmerTest)
library(dotwhisker)
library(kableExtra)
library(LMERConvenienceFunctions)
library(data.table)
library(gridExtra)
source('summarySEwithin2.R')
source('concatenate_raw_data.R')
source('annotate_the_raw_data.R')
source('declare_impossible_rt.R')
source('remove_impossible_trials.R')
source('pretty_coef_table.R')
source('pretty_coef_plot.R')
```

```{r "read in the data", echo=F}
dat <- concatenate_raw_data()
dat <- annotate_the_raw_data(dat)
# at this point RT has min=1 (resp_type="sticky") and max=59,999 (resp_type="timeout")
dat <- subset(dat, RT>1 & RT<59999)
# at this point RT has min=445, max=42,685 (42 seconds) and nrow(dat) is 7677 down from 7680
# Now trim the data
dat <- perSubjectTrim.fnc(data = dat, response='RT', subject='Subject', trim = 2.5)$data %>% select(-SD, -Mean, -Scaled)
# Now log the remaining RT
dat$RT_log <- log(dat$RT)
```

# Analysis including 6:15:24

```{r "make means table", echo=F, message=F, warning=F, results='hide'}
dat_plot <- summarySEwithin2(dat, measurevar="RT_log", withinvars=c("Vagueness", "Number", "Item"), idvar="Subject")
```

```{r "plotmeans", echo=F}
# correction from Morey (2008) applied to condition means
mywidth=0
pdodge=position_dodge(width=mywidth)
#
ggplot(dat_plot, aes(x=Item, y=RT_logNormed, group=Vagueness, ymin=RT_logNormed-ci, ymax=RT_logNormed+ci, shape=Vagueness, fill=Vagueness)) +
  facet_wrap(~Number) +
  scale_fill_grey(name="Vagueness", start=0, end=1) +  
  scale_shape_manual(name="Vagueness", values=c(21,22)) +
  theme(aspect.ratio = 1, panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background=element_rect(fill="white", colour="black")) +
  ylab("RT log(ms)") +
  #
  geom_errorbar(position=pdodge, width=0.25) +
  geom_line(position=pdodge) +
  geom_point(position=pdodge, size=2) 
```

Original full model
```{r "original full RT model", echo=F}
dat_model <- dat
dat_model$c_Vag <- ifelse(dat_model$Vagueness=="Crisp", -0.5, 0.5)
dat_model$c_Num <- ifelse(dat_model$Number=="Verbal", -0.5, 0.5)
dat_model$c_Itm <- ifelse(dat_model$Item=="06:15:24", -.75, ifelse(dat_model$Item=="16:25:34", -.25, ifelse(dat_model$Item=="26:35:44", .25, .75)))
rtFullModel <- lmerTest::lmer(1 + RT_log ~ c_Vag * c_Num + c_Itm + (1 + c_Vag * c_Num + c_Itm | Subject), dat_model)
pretty_coef_table(rtFullModel, "rtFullModel")
```

The reviewer wants us to re-run this analysis without 6:15:24 but just removing that level results in a model that doesn't converge.
I had to drop c_Vag * c_Itm and c_Itm slopes over subjects to get it to converge.

```{r "original full Model after dropping 6:15:24", echo=F}
dat_model <- droplevels(subset(dat, Item!="06:15:24"))
dat_model$c_Vag <- ifelse(dat_model$Vagueness=="Crisp", -0.5, 0.5)
dat_model$c_Num <- ifelse(dat_model$Number=="Verbal", -0.5, 0.5)
dat_model$c_Itm <- ifelse(dat_model$Item=="16:25:34", -.3333, ifelse(dat_model$Item=="26:35:44", .0000, .3333))

# now trying dropping c_Vag * Item slopes for subject, but the model didn't converge.
#rtFullModelMinus <- lmerTest::lmer(1 + RT_log ~ c_Vag * c_Num + c_Itm + (1 + c_Vag + c_Num + c_Itm | Subject), dat_model)

# now tring droppping c_Vag * Item slopes for subject, and c_Itm slopes for subject
rtFullModelMinus <- lmerTest::lmer(1 + RT_log ~ c_Vag * c_Num + c_Itm + (1 + c_Vag + c_Num  | Subject), dat_model)
pretty_coef_table(rtFullModelMinus, "rtFullModelMinus 6:15:24")
```

So, after dropping the 6:15:24 level, there is still a disadvantage for Vagueness, but it is not significant (p=.24). There is still a significant disadvantage for Numeric instruction format (p<.001). There is still a disadvantage for increasing the number of dots but it is not significant (p=.323). The interaction between Vagueness and Instruction format changes sign, and is now non-significant (beta=-.022, p=.374). 

However the full model and the reduced model are not really equivalent because the terms are different in order for the reduced model to converge. What we really want is a full model structure that converges with and without the 6:15:24 item.

If we use the structure of the reduced model for the structure of the full model we get this for the full model:

```{r "full RT model", echo=F}
dat_model <- dat
dat_model$c_Vag <- ifelse(dat_model$Vagueness=="Crisp", -0.5, 0.5)
dat_model$c_Num <- ifelse(dat_model$Number=="Verbal", -0.5, 0.5)
dat_model$c_Itm <- ifelse(dat_model$Item=="06:15:24", -.75, ifelse(dat_model$Item=="16:25:34", -.25, ifelse(dat_model$Item=="26:35:44", .25, .75)))
rtFullModel2 <- lmerTest::lmer(1 + RT_log ~ c_Vag * c_Num + c_Itm + (1 + c_Vag + c_Num  | Subject), dat_model)
pretty_coef_table(rtFullModel2, "rtFullModel2")
```

and this for the reduced model:

```{r}
pretty_coef_table(rtFullModelMinus, "rtFullModelMinus 6:15:24")
```




fullmodel with Helmert contrasts on Item
```{r "full RT model Helmert", echo=F}
dat_model <- dat
dat_model$c_Vag <- ifelse(dat_model$Vagueness=="Crisp", -0.5, 0.5)
dat_model$c_Num <- ifelse(dat_model$Number=="Verbal", -0.5, 0.5)
contrasts(dat_model$Item) <- contr.helmert(4)
# had to drop c_Vag * Item slopes for subject
rtFullModel_helmert <- lmerTest::lmer(1 + RT_log ~ c_Vag * c_Num + Item + (1 + c_Vag + c_Num + Item | Subject), dat_model)
pretty_coef_table(rtFullModel_helmert, "c_Vag * c_Num + Item + (1 + c_Vag + c_Num + Item | Subject)")
```

reducedmodel with Helmert contrasts on Item
```{r "reduced RT model Helmert", echo=F}
dat_model <- droplevels(subset(dat, Item!="06:15:24"))
dat_model$c_Vag <- ifelse(dat_model$Vagueness=="Crisp", -0.5, 0.5)
dat_model$c_Num <- ifelse(dat_model$Number=="Verbal", -0.5, 0.5)
contrasts(dat_model$Item) <- contr.helmert(3)
# had to drop c_Vag * Item slopes for subject
rtReducedModel_helmert <- lmerTest::lmer(1 + RT_log ~ c_Vag * c_Num + Item + (1 + c_Vag + c_Num + Item | Subject), dat_model)
pretty_coef_table(rtReducedModel_helmert, "c_Vag * c_Num + Item + (1 + c_Vag + c_Num + Item | Subject)")
```

However the plot of means suggests that the main variables are c_Num and Item so it might be better to have a model structure that includes a c_Num*Item term.

```{r}
dat_model <- dat
dat_model$c_Vag <- ifelse(dat_model$Vagueness=="Crisp", -0.5, 0.5)
dat_model$c_Num <- ifelse(dat_model$Number=="Verbal", -0.5, 0.5)
contrasts(dat_model$Item) <- contr.helmert(4)
myMod1 <- lmerTest::lmer(1 + RT_log ~ c_Vag + c_Num + Item + c_Num:Item +(1|Subject), dat_model)
pretty_coef_table(myMod1, "myMod1")
```

```{r}
dat_model <- droplevels(subset(dat, Item!="06:15:24"))
dat_model$c_Vag <- ifelse(dat_model$Vagueness=="Crisp", -0.5, 0.5)
dat_model$c_Num <- ifelse(dat_model$Number=="Verbal", -0.5, 0.5)
contrasts(dat_model$Item) <- contr.helmert(3)
myMod2 <- lmerTest::lmer(1 + RT_log ~ c_Vag + c_Num + Item + c_Num:Item +(1|Subject), dat_model)
pretty_coef_table(myMod2, "myMod2:no6:15:24")
```


<!-- Show which RTs were removed by trimming -->
<!-- ```{r} -->
<!-- ggplot(data=dat, aes(x=Trial, y=RT)) + -->
<!--   geom_point(aes(colour=was_RT_removed_by_trimming), size=.5) +  -->
<!--   facet_wrap(~Subject)+ -->
<!--   theme(aspect.ratio = 1, panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background=element_rect(fill="white", colour="black")) -->
<!-- ``` -->

<!-- Show which Rts were removed by trimming, shown as log RT -->
<!-- ```{r} -->
<!-- ggplot(data=dat, aes(x=Trial, y=log(RT))) + -->
<!--   geom_point(aes(colour=was_RT_removed_by_trimming), size=.5) +  -->
<!--   facet_wrap(~Subject)+ -->
<!--   theme(aspect.ratio = 1, panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background=element_rect(fill="white", colour="black")) -->
<!-- ``` -->

<!-- Show how distributions of Rt change according to trimming, in log RT -->
<!-- ```{r} -->
<!-- dat %>% gather(key=whether_trimmed, value=time, RT, RT_trimmed) %>% -->
<!--   ggplot(aes(log(time))) + -->
<!--   geom_density(aes(group=whether_trimmed, colour=whether_trimmed)) +  -->
<!--   facet_wrap(~Subject, scales="free") + -->
<!--   theme(aspect.ratio = 1, panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background=element_rect(fill="white", colour="black"))  -->
<!-- ``` -->

<!-- Make RT log and reciprocal, from the trimmed RT in ms. -->
<!-- ```{r} -->
<!-- dat$RT_trimmed_log <- log(dat$RT_trimmed) -->
<!-- dat$RT_trimmed_rcp <- -1/(dat$RT_trimmed) -->
<!-- ``` -->

<!-- plot transformations of rt in the trimmed data -->

<!-- ```{r, warning=FALSE, echo=F} -->
<!-- p.dens <- -->
<!-- dat %>% -->
<!--   gather(key=metric, value=value, RT_trimmed, RT_trimmed_log, RT_trimmed_rcp) %>% -->
<!--     ggplot(aes(value)) + -->
<!--     geom_density() + -->
<!--     facet_wrap(~metric, scales="free") + -->
<!--     theme(aspect.ratio = 1, panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background=element_rect(fill="white", colour="black")) -->
<!-- ``` -->

<!-- ```{r, warning=FALSE, echo=F} -->
<!-- p.point <- -->
<!-- dat %>% -->
<!--   gather(key=metric, value=value, RT_trimmed, RT_trimmed_log, RT_trimmed_rcp) %>% -->
<!--     ggplot(aes(x=Obs, y=value)) + -->
<!--     geom_point(size=.1) + -->
<!--     facet_wrap(~metric, scales="free") + -->
<!--     theme(aspect.ratio = 1, panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background=element_rect(fill="white", colour="black")) -->
<!-- ``` -->

<!-- ```{r, warning=FALSE, echo=F} -->
<!-- grid.arrange(p.dens,p.point) -->
<!-- ``` -->

<!-- Compute the ci's from untransformed data that were trimmed using summarysewithin2 and plot them on a log scale to reproduce the plot in the Springer submission. -->

<!-- ```{re2-rtplot, fig.width=7, fig.height=3.5, echo=FALSE, message=FALSE} -->
<!-- rtdataplot1 <- summarySEwithin2(dat, measurevar="RT_trimmed_log", withinvars=c("Vagueness", "Number", "Item"), idvar="Subject") -->

<!-- rtdataplot1$Condition <- as.factor(paste(sep=':', rtdataplot1$Number, rtdataplot1$Vagueness)) -->

<!-- ggplot(rtdataplot1, aes(x=Item, group=Condition, fill=Vagueness)) +  -->
<!--   geom_line(aes(x=Item, y=log(RT_trimmedNormed))) + -->
<!--   facet_grid(~Number) -->



<!-- +  -->
<!--   geom_errorbar(width=.2, aes(ymin=RT_trimmedNormed-ci, ymax=RT_trimmedNormed+ci)) +  -->
<!--   geom_point(size=2, col=1, aes(shape=Vagueness)) +  -->
<!--   scale_fill_grey(name="Vagueness", start=0, end=1) +   -->
<!--   scale_shape_manual(name="Vagueness", values=c(21,22)) +  -->
<!--   ggtitle("Response time") +  -->
<!--   ylab("Respone time (log (ms))") +  -->
<!--   xlab(NULL) +  -->
<!--   theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.key = element_blank(), legend.position="right", aspect.ratio=1, plot.background=element_rect(fill=NA, color='white'), strip.background=element_blank(), axis.text.x = element_text(angle = 15))  -->



<!-- ``` -->



<!-- ```{r e2-rtplot, fig.width=7, fig.height=3.5, echo=FALSE, message=FALSE} -->
<!-- rtdataplot1 <- summarySEwithin2(dat, measurevar="RT_trimmed_log", withinvars=c("Vagueness", "Number", "Item"), idvar="Subject") -->

<!-- rtdataplot1$Condition <- as.factor(paste(sep=':', rtdataplot1$Number, rtdataplot1$Vagueness)) -->

<!-- rtplot <-  -->
<!--   ggplot(rtdataplot1, aes(y=RT_trimmed_logNormed, x=Item, group=Condition, fill=Vagueness)) +  -->
<!--   geom_line() +  -->
<!--   geom_errorbar(width=.2, aes(ymin=RT_trimmed_logNormed-ci, ymax=RT_trimmed_logNormed+ci)) +  -->
<!--   geom_point(size=2, col=1, aes(shape=Vagueness)) +  -->
<!--   scale_fill_grey(name="Vagueness", start=0, end=1) +   -->
<!--   scale_shape_manual(name="Vagueness", values=c(21,22)) +  -->
<!--   ggtitle("Response time") +  -->
<!--   ylab("Respone time (log (ms))") +  -->
<!--   xlab(NULL) +  -->
<!--   theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.key = element_blank(), legend.position="right", aspect.ratio=1, plot.background=element_rect(fill=NA, color='white'), strip.background=element_blank(), axis.text.x = element_text(angle = 15)) + facet_grid(~Number) -->

<!-- rtplot -->
<!-- ``` -->


<!-- ## Response time models  -->

<!-- ### Full RT model -->

<!-- ```{r 'rt-full-model', cache=TRUE, echo=TRUE} -->
<!-- rtFullModel <- lmerTest::lmer(RT_log ~ c_Vag * c_Num + c_Itm + (1 + c_Vag * c_Num + c_Itm | Subject), rtdata) -->
<!-- ``` -->

<!-- ```{r 'make a pretty coefficients table for rtFullModel', echo=FALSE, results='asis'} -->
<!-- pretty_coef_table(rtFullModel, "rtFullModel") %>% print() -->
<!-- ``` -->

<!-- ```{r, 'make a pretty coefficients plot for rtFullModel', echo=FALSE, fig.width=6, fig.height=3} -->
<!-- pretty_coef_plot(rtFullModel, "rtFullModel") -->
<!-- ``` -->

<!-- ### Numeric only RT model -->

<!-- ```{r 'rt-numeric-only model', cache=TRUE, echo=TRUE} -->
<!-- rtNumOnlyModel <- lmerTest::lmer(RT_log ~ c_Vag + c_Itm + (1 + c_Vag + c_Itm | Subject), subset(rtdata,Number=="Numeric")) -->
<!-- ``` -->

<!-- ```{r 'make a pretty coefficients table for rtNumOnlyModel', echo=FALSE, results='asis'} -->
<!-- pretty_coef_table(rtNumOnlyModel, "rtNumOnlyModel") %>% print() -->
<!-- ``` -->

<!-- ```{r, 'make a pretty coefficients plot for rtNumOnlyModel', echo=FALSE, fig.width=6, fig.height=3} -->
<!-- pretty_coef_plot(rtNumOnlyModel, "rtNumOnlyModel") -->
<!-- ``` -->

<!-- ### Verbal only RT model -->

<!-- ```{r 'rt-verbal-only model', cache=TRUE, echo=TRUE} -->
<!-- rtVerbalOnlyModel <- lmerTest::lmer(RT_log ~ c_Vag + c_Itm + (1 + c_Vag + c_Itm | Subject), subset(rtdata,Number=="Verbal")) -->
<!-- ``` -->

<!-- ```{r 'make a pretty coefficients table for rtVerbalOnlyModel', echo=FALSE, results='asis'} -->
<!-- pretty_coef_table(rtVerbalOnlyModel, "rtVerbalOnlyModel") %>% print() -->
<!-- ``` -->

<!-- ```{r, 'make a pretty coefficients plot for rtVerbalOnlyModel', echo=FALSE, fig.width=6, fig.height=3} -->
<!-- pretty_coef_plot(rtVerbalOnlyModel, "rtVerbalOnlyModel") -->
<!-- ``` -->

<!-- # Borderline response data -->

<!-- ```{r} -->
<!-- bldata <- trim_data -->
<!-- ``` -->

<!-- ```{r e2-blBarChart, fig.width=7, fig.height=3.5, echo=FALSE, message=FALSE} -->
<!-- bldata$response_category <- relevel(bldata$response_category, ref='expected') -->

<!-- blBarChart = ggplot(bldata) + geom_bar(aes(response_category, group=Number:Vagueness, fill=Vagueness), position=position_dodge(width=NULL)) +   scale_fill_grey() + xlab(NULL) + ggtitle('Borderline response distribution') + facet_grid(~Number) + theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.key = element_blank(), legend.position="right", aspect.ratio=1, plot.background = element_rect(fill=NA, color='white'), strip.background=element_blank(), legend.key.size=unit(4, 'mm'), axis.text.x = element_text(angle = 15)) -->

<!-- blBarChart -->
<!-- ``` -->

<!-- ## Borderline response models -->

<!-- ### Full borderline response model -->

<!-- ```{r 'bl-full-model', cache=TRUE, echo=TRUE} -->
<!-- blFullModel <- lme4::glmer(isBorderline ~ c_Vag * c_Num + c_Itm + (1 + c_Vag * c_Num + c_Itm | Subject), bldata, family="binomial", control = glmerControl(optimizer = "bobyqa")) -->
<!-- ``` -->

<!-- ```{r 'make a pretty coefficients table for blFullModel', echo=FALSE, results='asis'} -->
<!-- pretty_coef_table(blFullModel, "blFullModel") %>% print() -->
<!-- ``` -->

<!-- ```{r, 'make a pretty coefficients plot for blFullModel', echo=FALSE, fig.width=6, fig.height=3} -->
<!-- pretty_coef_plot(blFullModel, "blFullModel") -->
<!-- ``` -->



<!-- Original fullmodel with Helmert contrasts on Item -->
<!-- ```{r "original full RT model Helmert", echo=4:5} -->
<!-- dat_model <- dat -->
<!-- dat_model$c_Vag <- ifelse(dat_model$Vagueness=="Crisp", -0.5, 0.5) -->
<!-- dat_model$c_Num <- ifelse(dat_model$Number=="Verbal", -0.5, 0.5) -->
<!-- contrasts(dat_model$Item) <- contr.helmert(4) -->
<!-- # had to drop c_Vag * Item slopes for subject -->
<!-- rtFullModel_helmert <- lmerTest::lmer(1 + RT_log ~ c_Vag * c_Num + Item + (1 + c_Vag + c_Num + Item | Subject), dat_model) -->
<!-- pretty_coef_table(rtFullModel_helmert, "rtFullModel Helmert") -->
<!-- ``` -->




<!-- # Re-run without 6:15:24 -->
<!-- ```{r, echo=F, message=F, warning=F, results='hide'} -->
<!-- dat_reduced <- droplevels(subset(dat, Item!="06:15:24")) -->
<!-- dat_plot <- summarySEwithin2(dat_reduced, measurevar="RT_log", withinvars=c("Vagueness", "Number", "Item"), idvar="Subject") -->
<!-- ``` -->

<!-- ```{r, echo=F, results='hide'} -->
<!-- # correction from Morey (2008) applied to condition means -->
<!-- mywidth=0 -->
<!-- pdodge=position_dodge(width=mywidth) -->
<!-- # -->
<!-- ggplot(dat_plot, aes(x=Item, y=RT_logNormed, group=Vagueness, ymin=RT_logNormed-ci, ymax=RT_logNormed+ci, shape=Vagueness, fill=Vagueness)) + -->
<!--   facet_wrap(~Number) + -->
<!--   scale_fill_grey(name="Vagueness", start=0, end=1) +   -->
<!--   scale_shape_manual(name="Vagueness", values=c(21,22)) + -->
<!--   theme(aspect.ratio = 1, panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background=element_rect(fill="white", colour="black")) + -->
<!--   ylab("RT log(ms)") + -->
<!--   # -->
<!--   geom_errorbar(position=pdodge, width=0.25) + -->
<!--   geom_line(position=pdodge) + -->
<!--   geom_point(position=pdodge, size=2)  -->
<!-- ``` -->