---
title: "Experiment 2 of 4"
author: "Matt Green"
output:
  html_document:
    toc: yes
    toc_float: true
    mathjax: default
    template: default
    <!--code_folding: show-->
    theme: default
---

```{r "set working directory to 2018_tidy_version", echo=FALSE}
root="/home/matt/wd/vagueness/experiments/e2/writeup/2018_tidy_version"
if (getwd() != root) setwd(root)
```

```{r "load Libraries and source my functions", message=FALSE, echo=FALSE}
library(knitr)
library(tidyverse)
library(tidymodels)
library(broom.mixed)
library(lme4)
library(lmerTest)
library(dotwhisker)
library(kableExtra)
library(LMERConvenienceFunctions)
library(data.table)
source('../functions/summarySEwithin2.R')
source('../functions/e2-preprocessing.R')
source('../functions/pretty_coef_table.R')
source('../functions/pretty_coef_plot.R')
```

In this experiment we did not count any response as an error, instead we coded them as expected, borderline, and extreme.

These are the example instructions:
```{r showInstructions, echo=FALSE}
data.frame(
  vagueness = c("crisp", "crisp", "vague", "vague"),
  number = c('number', 'word', 'number', 'word'),
  example_instruction = c("Choose the square with 6 dots", "Choose the square with the fewest dots", "Choose a square with about 10 dots", "Choose a square with few dots")  
) %>% kable() %>% kable_styling(full_width = F, position = "left", font_size = 11)
```

These are the items:
```{r showItems, echo=FALSE}
data.frame(
  Item = c("1","2","3","4"),
  'Numbers of dots' = c("06:15:24", "16:25:34", "26:35:44", "36:45:54")
) %>% kable() %>% kable_styling(full_width = F, position = "left", font_size = 11)
```

Pre-process the raw data.
```{r preprocessing, echo=FALSE, message=FALSE}
if( !file.exists('e2-data.txt') ) {
  dat <- gatherData() 
  dat <- declareImpossibleRT(dat)
  #dat <- removeImpossibleTrials(dat)
  dat <- subset(dat, select=c(Subject, Trial, Item, c_Itm, discriminability, Instruction, nchar_instr, Vagueness, Number, Order, Quantity, c_Vag, c_Num, c_Ord, c_Qty, NaType, response_category, isBorderline, RT, RT_log))
  write.table(dat, file='e2-data.txt', sep='\t', quote=FALSE, row.names = FALSE)
}
```

```{r}
raw_data <- read.delim('e2-data.txt')
```

```{r}
trim_data <- perSubjectTrim.fnc(data = raw_data[complete.cases(raw_data),], response='RT', subject='Subject', trim = 2.5)$data
```

# Response time data

```{r}
rtdata <- trim_data
```

```{r e2-rtplot, fig.width=7, fig.height=3.5, echo=FALSE, message=FALSE}
rtdataplot1 <- summarySEwithin2(rtdata, measurevar="RT_log", withinvars=c("Vagueness", "Number", "Item"), idvar="Subject")

rtdataplot1$Condition <- as.factor(paste(sep=':', rtdataplot1$Number, rtdataplot1$Vagueness))

rtplot=ggplot(rtdataplot1, aes(y=RT_logNormed, x=Item, group=Condition, fill=Vagueness)) + geom_line() + geom_errorbar(width=.2, aes(ymin=RT_logNormed-ci, ymax=RT_logNormed+ci)) + geom_point(size=2, col=1, aes(shape=Vagueness)) + scale_fill_grey(name="Vagueness", start=0, end=1) +  scale_shape_manual(name="Vagueness", values=c(21,22)) + ggtitle("Response time") + ylab("Respone time (log (ms))") + xlab(NULL) + theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.key = element_blank(), legend.position="right", aspect.ratio=1, plot.background=element_rect(fill=NA, color='white'), strip.background=element_blank(), axis.text.x = element_text(angle = 15)) + facet_grid(~Number)

rtplot
```


## Response time models 

### Full RT model

```{r 'rt-full-model', cache=TRUE, echo=TRUE}
rtFullModel <- lmerTest::lmer(RT_log ~ c_Vag * c_Num + c_Itm + (1 + c_Vag * c_Num + c_Itm | Subject), rtdata)
```

```{r 'make a pretty coefficients table for rtFullModel', echo=FALSE, results='asis'}
pretty_coef_table(rtFullModel, "rtFullModel") %>% print()
```

```{r, 'make a pretty coefficients plot for rtFullModel', echo=FALSE, fig.width=6, fig.height=3}
pretty_coef_plot(rtFullModel, "rtFullModel")
```

### Numeric only RT model

```{r 'rt-numeric-only model', cache=TRUE, echo=TRUE}
rtNumOnlyModel <- lmerTest::lmer(RT_log ~ c_Vag + c_Itm + (1 + c_Vag + c_Itm | Subject), subset(rtdata,Number=="Numeric"))
```

```{r 'make a pretty coefficients table for rtNumOnlyModel', echo=FALSE, results='asis'}
pretty_coef_table(rtNumOnlyModel, "rtNumOnlyModel") %>% print()
```

```{r, 'make a pretty coefficients plot for rtNumOnlyModel', echo=FALSE, fig.width=6, fig.height=3}
pretty_coef_plot(rtNumOnlyModel, "rtNumOnlyModel")
```

### Verbal only RT model

```{r 'rt-verbal-only model', cache=TRUE, echo=TRUE}
rtVerbalOnlyModel <- lmerTest::lmer(RT_log ~ c_Vag + c_Itm + (1 + c_Vag + c_Itm | Subject), subset(rtdata,Number=="Verbal"))
```

```{r 'make a pretty coefficients table for rtVerbalOnlyModel', echo=FALSE, results='asis'}
pretty_coef_table(rtVerbalOnlyModel, "rtVerbalOnlyModel") %>% print()
```

```{r, 'make a pretty coefficients plot for rtVerbalOnlyModel', echo=FALSE, fig.width=6, fig.height=3}
pretty_coef_plot(rtVerbalOnlyModel, "rtVerbalOnlyModel")
```

# Borderline response data

```{r}
bldata <- trim_data
```

```{r e2-blBarChart, fig.width=7, fig.height=3.5, echo=FALSE, message=FALSE}
bldata$response_category <- relevel(bldata$response_category, ref='expected')

blBarChart = ggplot(bldata) + geom_bar(aes(response_category, group=Number:Vagueness, fill=Vagueness), position=position_dodge(width=NULL)) +   scale_fill_grey() + xlab(NULL) + ggtitle('Borderline response distribution') + facet_grid(~Number) + theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.key = element_blank(), legend.position="right", aspect.ratio=1, plot.background = element_rect(fill=NA, color='white'), strip.background=element_blank(), legend.key.size=unit(4, 'mm'), axis.text.x = element_text(angle = 15))

blBarChart
```

## Borderline response models

### Full borderline response model

```{r 'bl-full-model', cache=TRUE, echo=TRUE}
blFullModel <- lme4::glmer(isBorderline ~ c_Vag * c_Num + c_Itm + (1 + c_Vag * c_Num + c_Itm | Subject), bldata, family="binomial", control = glmerControl(optimizer = "bobyqa"))
```

```{r 'make a pretty coefficients table for blFullModel', echo=FALSE, results='asis'}
pretty_coef_table(blFullModel, "blFullModel") %>% print()
```

```{r, 'make a pretty coefficients plot for blFullModel', echo=FALSE, fig.width=6, fig.height=3}
pretty_coef_plot(blFullModel, "blFullModel")
```
